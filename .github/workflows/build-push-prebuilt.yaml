# Build and push pre-built Beaver IoT image (monorepo platformariot) to GHCR.
# Uses local backend/, web/, integrations/, build-docker/ â€“ no git clone.

name: Build and push prebuilt image

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - backend/**
      - web/**
      - integrations/**
      - build-docker/**
      - scripts/**
      - examples/**
      - .github/workflows/build-push-prebuilt.yaml

env:
  REGISTRY: ghcr.io
  IMAGE: ghcr.io/rifatsekerariot/beaver-iot

jobs:
  build-push:
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: "1"
      COMPOSE_DOCKER_CLI_BUILD: "1"
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restructure workspace (monorepo: no-op)
        run: sh scripts/restructure-ci-workspace.sh

      - name: Build ChirpStack JAR from integrations/
        run: sh scripts/ci-build-jar.sh

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-flags: "--allow-insecure-entitlement network.host"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create .env for build
        run: sh scripts/create-build-env.sh

      - name: Ensure web/ present (monorepo: no-op if exists)
        run: sh scripts/ci-clone-web.sh

      - name: Verify web source (widget fixes)
        run: sh scripts/verify-web-source.sh web

      - name: Build web + api + monolith (local dockerfiles, repo root context)
        run: sh scripts/build-prebuilt.sh

      - name: Log web image widget chunks (diagnostic)
        run: |
          echo "=== Web image /web/assets/js (first 60) ==="
          docker run --rm --entrypoint sh milesight/beaver-iot-web:latest -c "ls /web/assets/js | head -60"
          echo "=== useAlarmEmphasis / DrawingBoard chunks ==="
          docker run --rm --entrypoint sh milesight/beaver-iot-web:latest -c "ls /web/assets/js | grep -E '^useAlarmEmphasis-|^DrawingBoard-' || true"

      - name: Verify web image
        run: sh scripts/verify-web-image.sh

      - name: PostgreSQL stack smoke test
        run: |
          cd examples
          BEAVER_IMAGE=milesight/beaver-iot:latest docker compose -f chirpstack-prebuilt-postgres.yaml up -d
          echo "Waiting 90s for monolith (Java+PostgreSQL, t_alarm migration)..."
          sleep 90
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9080/ || true)
          echo "GET http://localhost:9080/ -> $HTTP"
          if [ "$HTTP" != "200" ] && [ "$HTTP" != "302" ]; then
            echo "PostgreSQL smoke test failed: expected 200/302, got $HTTP"
            docker compose -f chirpstack-prebuilt-postgres.yaml logs monolith 2>&1 | tail -80
            docker compose -f chirpstack-prebuilt-postgres.yaml down -v
            exit 1
          fi
          docker compose -f chirpstack-prebuilt-postgres.yaml down -v
          echo "PostgreSQL smoke test OK."

      - name: Tag and push monolith to GHCR
        run: sh scripts/tag-push-ghcr.sh
