# platformariot: Tek CI â€“ PostgreSQL + Alarm + widget'lar. Imaj GHCR'a push.
# backend/, web/, integrations/, build-docker/ yerel; git clone yok.
# Tetikleme: push (main, paths) veya workflow_dispatch.
# 2026-01-27: ci tetikle (workflow_dispatch alternatifi)

name: Build

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - backend/**
      - web/**
      - integrations/**
      - blueprint/**
      - build-docker/**
      - scripts/**
      - examples/**
      - .github/workflows/build-push-prebuilt.yaml

env:
  REGISTRY: ghcr.io
  IMAGE: ghcr.io/rifatsekerariot/beaver-iot

jobs:
  build-push:
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: "1"
      COMPOSE_DOCKER_CLI_BUILD: "1"
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Restructure workspace (monorepo no-op)
        run: sh scripts/restructure-ci-workspace.sh

      - name: Build ChirpStack JAR from integrations/
        run: sh scripts/ci-build-jar.sh

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          buildkitd-flags: "--allow-insecure-entitlement network.host"

      # password: GHCR_PAT (gittoken.txt) tercih; yoksa GITHUB_TOKEN. GHCR_PAT = repo Secret.
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GHCR_PAT || secrets.GITHUB_TOKEN }}

      - name: Create .env for build
        run: sh scripts/create-build-env.sh

      - name: Verify web source (widget fixes)
        run: sh scripts/verify-web-source.sh web

      - name: Build web + api + monolith (local dockerfiles, repo root context)
        run: sh scripts/build-prebuilt.sh

      - name: Verify API image contains alarm module
        run: |
          echo "=== API JAR: alarm-service / AlarmsController ==="
          if ! docker run --rm --entrypoint sh milesight/beaver-iot-api:latest -c "jar tf /application.jar | grep -E 'alarm-service|alarm/'"; then
            echo "ERROR: API JAR does not contain alarm-service or alarm classes. Check -am and application-standard pom dependency."
            exit 1
          fi
          echo "alarm module present in API image OK."

      - name: Log web image widget chunks (diagnostic)
        run: |
          echo "=== Web image /web/assets/js (first 60) ==="
          docker run --rm --entrypoint sh milesight/beaver-iot-web:latest -c "ls /web/assets/js | head -60"
          echo "=== useAlarmEmphasis / DrawingBoard chunks ==="
          docker run --rm --entrypoint sh milesight/beaver-iot-web:latest -c "ls /web/assets/js | grep -E '^useAlarmEmphasis-|^DrawingBoard-' || true"

      - name: Verify web image
        run: sh scripts/verify-web-image.sh

      - name: PostgreSQL stack smoke test + alarm verification
        run: |
          cd examples
          BEAVER_IMAGE=milesight/beaver-iot:latest docker compose -f stack.yaml up -d
          echo "Waiting 90s for monolith (Java+PostgreSQL, t_alarm)..."
          sleep 90
          HTTP=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:9080/ || true)
          echo "GET http://localhost:9080/ -> $HTTP"
          if [ "$HTTP" != "200" ] && [ "$HTTP" != "302" ]; then
            echo "PostgreSQL smoke test failed: expected 200/302, got $HTTP"
            docker compose -f stack.yaml logs monolith 2>&1 | tail -80
            docker compose -f stack.yaml down -v
            exit 1
          fi
          echo "PostgreSQL smoke test OK."
          echo "=== Alarm module verification ==="
          CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST http://localhost:9080/api/v1/alarms/search -H "Content-Type: application/json" -d "{}")
          if [ "$CODE" = "401" ] || [ "$CODE" = "403" ]; then
            echo "POST /api/v1/alarms/search -> $CODE (alarm endpoint reachable, auth required)"
            echo "alarm verification OK."
          else
            echo "ERROR: POST /api/v1/alarms/search returned $CODE (expected 401/403 when unauthenticated)"
            echo "actuator/mappings (diagnostic):"
            curl -s http://localhost:9080/actuator/mappings 2>/dev/null | head -c 500 || true
            echo ""
            docker compose -f stack.yaml logs monolith 2>&1 | tail -50
            docker compose -f stack.yaml down -v
            exit 1
          fi
          docker compose -f stack.yaml down -v

      - name: Tag and push monolith to GHCR
        run: sh scripts/tag-push-ghcr.sh
