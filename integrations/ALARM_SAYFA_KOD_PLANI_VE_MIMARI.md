# Alarm Sayfası — Kod Planı ve Mimari

**Tarih:** 2026-01-27  
**Amaç:** Ana panelde Alarm sayfası (liste + kurallar sekmeleri), alarm widget’ta “Kuralları yönet” linki. PostgreSQL üzerinde.

**Referanslar:** ALARM_MANTIGI_VE_MIMARI_ONERI_RAPORU.md, ALARM_IF_THEN_ALANLARI_DASHBOARD_OZET.md, ALARM_API_BEAVER_IOT_MAIN_RAPORU.md

---

## 1. Mimari Özet

```
[Frontend: beaver-iot-web]
  /alarm sayfası (sekme: Alarm listesi | Alarm kuralları)
  Alarm widget → "Kuralları yönet" linki → /alarm (veya /alarm?tab=rules)

[Backend: beaver-iot-main]
  POST /api/v1/alarms/search, GET /api/v1/alarms/export, POST /api/v1/alarms/claim  (Faz 1)
  [Faz 2] Alarm kuralları: CRUD API, alarm_rule tablosu, kural değerlendirme

[DB: PostgreSQL]
  t_alarm (Faz 1), t_alarm_rule (Faz 2)
```

---

## 2. Faz 1 — Alarm Listesi + Backend API (MVP)

### 2.1 Backend (beaver-iot-main)

#### 2.1.1 Yeni modül: `alarm-service`

- **Konum:** `services/alarm/` (device, entity ile aynı seviye).
- **Yapı:**
  - `alarm-service/pom.xml` — parent: services, bağımlılık: `device-service`, `context`, `permission-service`, `data-jpa` (veya `data-timeseries-jpa`/entity’ye gerek yoksa sadece spring-boot-starter-data-jpa benzeri mevcut data katmanı), `base` (ResponseBody, ResponseBuilder, Page).
  - `alarm-service/src/.../alarm/controller/AlarmsController.java`
  - `alarm-service/src/.../alarm/service/AlarmService.java`
  - `alarm-service/src/.../alarm/repository/AlarmRepository.java`
  - `alarm-service/src/.../alarm/po/AlarmPO.java`
  - `alarm-service/src/.../alarm/model/request/AlarmSearchRequest.java`, `AlarmClaimRequest.java`
  - `alarm-service/src/.../alarm/model/response/AlarmDetailResponse.java` (DeviceAlarmDetail ile uyumlu: id, alarm_status, alarm_time, alarm_content, latitude, longitude, address, device_id, device_name)

- **services/pom.xml:** `<module>alarm</module>` ekle.
- **application-standard/pom.xml:**  
  `alarm-service` dependency ekle.

#### 2.1.2 Veritabanı (PostgreSQL)

- **Changelog:** `db/postgres/changelog.yaml` içine `sql/v1.4.0` include ekle (v1.3.1’den sonra).
- **Yeni klasör:** `db/postgres/sql/v1.4.0/`
- **alarm.sql (Liquibase):**

```sql
-- liquibase formatted sql
-- changeset alarm:v1.4.0_20260127
CREATE TABLE t_alarm (
    id             BIGINT       NOT NULL GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    tenant_id      VARCHAR(255) NOT NULL,
    device_id      BIGINT       NOT NULL,
    alarm_time     BIGINT       NOT NULL,
    alarm_content  VARCHAR(1024),
    alarm_status   BOOLEAN      NOT NULL DEFAULT TRUE,   -- true=aktif, false=claimed
    latitude       DOUBLE PRECISION,
    longitude      DOUBLE PRECISION,
    address        VARCHAR(512),
    entity_key     VARCHAR(512),
    source         VARCHAR(64),  -- REPORT_EVENT | WORKFLOW | RULE | MANUAL
    created_at     BIGINT
);
CREATE INDEX idx_alarm_tenant_device ON t_alarm (tenant_id, device_id);
CREATE INDEX idx_alarm_tenant_time ON t_alarm (tenant_id, alarm_time);
CREATE INDEX idx_alarm_tenant_status ON t_alarm (tenant_id, alarm_status);
```

- **Not:** `GENERATED BY DEFAULT AS IDENTITY` PostgreSQL uyumludur; H2 farklı ise ayrı H2 changeset gerekebilir (PostgreSQL odaklı projede şimdilik yeterli).

#### 2.1.3 AlarmsController

- `@RestController`, `@RequestMapping("/alarms")` — prefix `/api/v1` üst katmandan (nginx/gateway) geliyorsa sadece `/alarm`; değilse uygulama `server.servlet.context-path` veya global prefix ile. Mevcut Controller’lar `/device`, `/entity` kullanıyor; aynı mantık.
- **Endpoint’ler:**
  - `POST /alarms/search` — `AlarmSearchRequest` (page_number, page_size, device_ids, start_timestamp, end_timestamp, alarm_status, keyword, timezone). `Page<AlarmDetailResponse>`. TenantContext’ten tenant_id. DeviceRepository/DeviceService ile device name, DeviceLocationService ile lat/lon/address doldur.
  - `GET /alarms/export` — aynı filtre parametreleri (query). CSV Blob; `Content-Disposition: attachment`. Entity export örnek alınabilir.
  - `POST /alarms/claim` — body: `{ "device_id": number }`. İlgili tenant + device_id ve `alarm_status=true` olanları `alarm_status=false` yap.
- **Yetkilendirme:** `@OperationPermission` — `DEVICE_VIEW` veya yeni `ALARM_VIEW`, `ALARM_CLAIM`. Faz 1’de `DEVICE_VIEW` ile başlanabilir; `PERMISSIONS` ve backend `OperationPermissionCode`’a `ALARM_MODULE`, `ALARM_VIEW`, `ALARM_CLAIM` eklenebilir.

#### 2.1.4 AlarmService

- `search(AlarmSearchRequest)`, `export(...)`, `claim(deviceId)`.
- `AlarmRepository`: JPA `AlarmPO`, `JpaRepository<AlarmPO, Long>`. Tenant filtreleme: `AlarmPO`’da `tenant_id`; sorguda `tenant_id = TenantContext.getTenantId()`.
- device_id ile `DeviceService`/`DeviceRepository`’den isim; `DeviceLocationService`’den konum (alarm kaydında yoksa cihazdan al).

#### 2.1.5 Tenant

- `TenantContext` / `TenantId` kullanımı mevcut controller’larla aynı. `AlarmPO` ve servislerde `tenant_id` zorunlu.

---

### 2.2 Frontend (beaver-iot-web)

#### 2.2.1 Route ve menü

- **routes.tsx:**  
  - `path: '/alarm'` (dashboard ile workflow arasına veya uygun yere).  
  - `handle`: `title` (örn. `intl.get('alarm.title')` veya `'Alarm'`), `icon` (örn. `AntFallAttentionIcon` veya `ListAltIcon`), `permissions: PERMISSIONS.ALARM_MODULE` (veya `DEVICE_VIEW` geçici).  
  - `lazy` → `@/pages/alarm`.
- **constants.ts (PERMISSIONS):**  
  `ALARM_MODULE = 'alarm'`, `ALARM_VIEW = 'alarm.view'`, `ALARM_CLAIM = 'alarm.claim'` (ve `ALARM_RULES_MANAGE` Faz 2).
- **user-role/role/constants.ts:** `[PERMISSIONS.ALARM_MODULE]: 'alarm'` (veya i18n key) ekle. Backend menü/rol tarafı aynı code ile eşleşecek şekilde (Faz 2’de detay).

#### 2.2.2 Sayfa: `pages/alarm/`

- **index.tsx:**  
  - Üstte **Tabs**: “Alarm listesi” | “Alarm kuralları”.  
  - “Alarm listesi” → `<AlarmList />`, “Alarm kuralları” → `<AlarmRules />` (Faz 1’de placeholder: “Yakında” veya basit “Kural ekle” butonu + boş liste).
- **views/AlarmList (veya components):**  
  - `deviceAPI.getDeviceAlarms` (yani `POST /api/v1/alarm/search` — path’i device.ts’te `getDeviceAlarms` eşlemesiyle uyumlu yap; şu an `alarms/search` bekleniyor, backend `/alarm/search` ise API_PREFIX sonrası `/alarm/search` olmalı. **Uyum:** Frontend `device.ts`: `getDeviceAlarms: POST ${API_PREFIX}/alarms/search`. Backend’i `@RequestMapping("/alarms")` + `@PostMapping("/search")` yapmak daha uyumlu; yoksa frontend’de `alarm/search` path’i kullanılacak yeni bir `alarmAPI` tanımı.  
  - **Tercih:** Backend’i frontend’e uydur: `@RequestMapping("/alarms")`, `@PostMapping("/search")`, `@GetMapping("/export")`, `@PostMapping("/claim")`.  
  - Alarm listesi: cihaz seçimi (MultiDeviceSelect benzeri), tarih aralığı, alarm_status filtresi, keyword. Tablo: id, device_name, alarm_time, alarm_content, alarm_status, claim butonu, export. Mevcut `plugins/alarm` view/hooks (useDeviceData, useColumns, useAlarmClaim) ile benzer mantık; mümkünse ortak bölümler (ör. useDeviceData’daki getDeviceAlarms çağrısı) reuse veya `alarm` sayfası için sadeleştirilmiş bir hook.
- **services/http:**  
  - `device.ts` içindeki `getDeviceAlarms`, `exportDeviceAlarms`, `claimDeviceAlarm` path’leri: `/alarms/search`, `/alarms/export`, `/alarms/claim`. Backend `/alarms` ise aynen çalışır.  
  - (Opsiyonel) `alarm.ts` ve `alarmAPI` — list sayfası `deviceAPI` kullanıyorsa gerek yok.

#### 2.2.3 Alarm widget’ta “Kuralları yönet” linki

- **plugins/alarm/view/index.tsx** (veya `view/components/`, toolbar benzeri bir üst alan):  
  - `configJson.isPreview` veya `context?.isEdit` değilse, tablo/liste üstünde veya SearchSlot yanında:  
    `Link` veya `Typography` + `Link` → `to="/alarm"` veya `to="/alarm?tab=rules"`. Metin: `intl.get('alarm.manage_rules')` veya `'Kuralları yönet'`.  
  - `useNavigate` veya `Link` (react-router) kullanımı mevcut projeyle uyumlu olsun.

#### 2.2.4 i18n

- `alarm.title`, `alarm.manage_rules`, `alarm.tab_list`, `alarm.tab_rules`, `alarm.placeholder_rules` (Faz 1 için). `locales` içinde `en`, `tr` (varsa) ekle.

---

### 2.3 API Path Uyumu (Frontend–Backend)

- **Frontend (device.ts):**  
  - `getDeviceAlarms` → `POST ${API_PREFIX}/alarms/search`  
  - `exportDeviceAlarms` → `GET ${API_PREFIX}/alarms/export` (params)  
  - `claimDeviceAlarm` → `POST ${API_PREFIX}/alarms/claim`
- **Backend:**  
  - `@RequestMapping("/alarms")`  
  - `@PostMapping("/search")`, `@GetMapping("/export")`, `@PostMapping("/claim")`  
- **Nginx/gateway:** `/api/v1` → uygulama; nihai URL’ler: `/api/v1/alarms/search`, `/api/v1/alarms/export`, `/api/v1/alarms/claim`. Frontend `API_PREFIX=/api/v1` ile aynı.

---

### 2.4 Faz 1 Dosya Listesi (Özet)

**beaver-iot-main**

- `services/pom.xml` — alarm modülü
- `services/alarm/pom.xml`
- `services/alarm/.../AlarmsController.java`
- `services/alarm/.../AlarmService.java`
- `services/alarm/.../AlarmRepository.java`
- `services/alarm/.../AlarmPO.java`
- `services/alarm/.../AlarmSearchRequest.java`, `AlarmClaimRequest.java`, `AlarmDetailResponse.java`
- `application/application-standard/pom.xml` — alarm-service dependency
- `application/.../db/postgres/changelog.yaml` — v1.4.0 include
- `application/.../db/postgres/sql/v1.4.0/alarm.sql`
- (İsteğe bağlı) `OperationPermissionCode` ve menü/rol: `ALARM_*`

**beaver-iot-web**

- `apps/web/src/constants.ts` — `PERMISSIONS.ALARM_MODULE` (ve `ALARM_VIEW`, `ALARM_CLAIM`)
- `apps/web/src/routes/routes.tsx` — `/alarm` route
- `apps/web/src/pages/alarm/index.tsx` — Tabs + AlarmList + AlarmRules (placeholder)
- `apps/web/src/pages/alarm/views/AlarmList.tsx` (veya `components/`) — tablo, filtre, deviceAPI çağrıları
- `apps/web/src/pages/alarm/views/AlarmRules.tsx` — Faz 1: “Yakında” veya basit mesaj
- `apps/web/src/components/drawing-board/plugin/plugins/alarm/view/index.tsx` (veya view’da uygun bileşen) — “Kuralları yönet” linki
- `apps/web/.../user-role/views/role/constants.ts` — ALARM_MODULE eşlemesi
- `packages/locales/.../en/...json` (ve tr) — alarm.* anahtarları

---

## 3. Faz 2 — Alarm Kuralları (Kısa Plan)

- **Tablo:** `t_alarm_rule` — id, tenant_id, name, device_ids (JSON/ARRAY veya ayrı ilişki tablosu), entity_key, condition (JSON: op, value), action (raise_alarm, notify_email, notify_webhook), enabled.
- **API:** `POST/GET /alarms/rules`, `PUT /alarms/rules/:id`, `DELETE /alarms/rules/:id`.
- **Rules sekmesi:** Form (cihaz çoklu, entity, koşul op+değer, aksiyon) + liste. Bu form `alarm_rule` CRUD’a bağlanır.
- **Kural motoru:** Entity `UPDATE_PROPERTY` veya zamanlı kontrol ile kural değerlendirme; koşul sağlanırsa `AlarmService` ile alarm kaydı + isteğe bağlı bildirim. (Ayrı tasarım dokümanı.)

Faz 1 tamamlanıp testler yeşil olduktan sonra Faz 2 detaylandırılır.

---

## 4. Repo ve CI/CD

- **beaver-iot-main (veya fork: beaver-iot):** alarm-service, t_alarm, AlarmsController, AlarmService, changelog. Push → API imajı bu repodan build edildiği için yeni build’de alarm API dahil olur.
- **beaver-iot-web:** /alarm, alarm widget linki, PERMISSIONS, i18n. Push → web imajı güncellenir.
- **beaver-iot-docker:**  
  - `create-build-env.sh` (veya CI’da kullanılan env): `API_GIT_REPO_URL` proje fork’una (ör. `https://github.com/rifatsekerariot/beaver-iot.git`) ve `API_GIT_BRANCH` (örn. `main`) işaret etmeli. PostgreSQL workflow’u (`build-push-prebuilt-postgres.yaml`) aynı kalabilir; build sırasında API ve Web clone’ları bu fork’lardan alınır.
- **beaver (integrations):** Bu özellik için değişiklik yok.

---

## 5. Lokal Docker ve PostgreSQL

- **Compose:** `examples/chirpstack-prebuilt-postgres.yaml` (veya projenin kullandığı Postgres’li compose). `BEAVER_IMAGE` ile çalıştırılır.
- **İmaj:** Önce `build-prebuilt.sh` (veya eşdeğer) ile web + api + monolith build; API ve Web repo’ları build script’te tanımlı URL’lerden alınır. Proje fork’ları kullanılacaksa `.env` / script’te `API_GIT_REPO_URL`, `WEB_GIT_REPO_URL` buna göre ayarlanmalı.
- **Çalıştırma:** `examples/` altında `docker compose -f chirpstack-prebuilt-postgres.yaml up -d`. Port 9080. Migrations (Liquibase) uygulama ayağa kalkarken `t_alarm`’ı oluşturur.

---

## 6. Belgelerden ve Önceki Çalışmalardan Yararlanılan Noktalar

- **ALARM_API_BEAVER_IOT_MAIN_RAPORU:** Eksik endpoint’ler, DeviceAlarmDetail alanları, AlarmSearchCondition. Path: `/alarms/search`, `/alarms/export`, `/alarms/claim`.
- **ALARM_MANTIGI_VE_MIMARI_ONERI_RAPORU:** t_alarm alanları (device_id, alarm_time, alarm_content, alarm_status, latitude, longitude, address, entity_key, source, tenant_id). Claim: device_id ile toplu.
- **ALARM_IF_THEN_ALANLARI_DASHBOARD_OZET:** Ana panelde /alarm, Liste + Kurallar sekmeleri, “Kuralları yönet” linki, Dashboard’a dokunmama.
- **beaver-iot-docs (eventbus, entity-definition):** REPORT_EVENT, Event entity — Faz 2/3’te kural ve alarm kaynağı olarak kullanılacak.
- **DeviceController, EntityController, postgres changelog, device/dashboard tabloları:** Path, `@RequestMapping`, `OperationPermission`, Liquibase formatı, `tenant_id` kullanımı.
- **constants.ts PERMISSIONS, role constants, routes.tsx:** Yeni modül ve route ekleme kalıbı.
- **plugins/alarm view, useDeviceData, deviceAPI:** getDeviceAlarms, export, claim kullanımı; “Kuralları yönet” linkinin ekleneceği yer.

---

*Bu doküman kod planı ve mimari referans içerir; implementasyon adımları test planları ile birlikte uygulanacaktır.*
